# Deployment Guide — Vibe Beats

This guide covers deploying Vibe Beats to production.

## Pre-Deployment Checklist

- [ ] Backend is deployed (see `docs/BACKEND_SETUP.md`)
- [ ] KV store table created and accessible
- [ ] Environment variables configured in Supabase
- [ ] Service worker precache updated to built assets
- [ ] Auth flow verified (tokens are properly generated and verified)
- [ ] All API endpoints tested and working
- [ ] UI tested on iOS/Android browsers and PWA installed

## Build

### Build Web App

```bash
npm run build
# or
pnpm build
```

Output is generated in `dist/` or `build/` directory (see `vite.config.ts`).

### Verify Build

```bash
# Check built files exist
ls dist/   # or ls build/

# Test service worker is present
ls dist/service-worker.js
```

## Service Worker & PWA

### Update Service Worker Precache

The service worker in `src/service-worker.js` currently caches source files. Update it to cache built assets:

**Current (Source files):**
```javascript
const PRECACHE_ASSETS = [
  '/',
  '/App.tsx',
  '/styles/globals.css'
];
```

**Updated (Built assets):**
```javascript
const PRECACHE_ASSETS = [
  '/',
  '/index.html',
  '/manifest.json',
  '/service-worker.js'
  // assets are typically cache-first dynamically; add major JS/CSS if needed
];
```

Or use a build-time precache manifest generated by `vite-plugin-pwa` or `workbox`.

### Verify Manifest

Ensure `public/manifest.json` is correct:
- `name`, `short_name` are set
- `start_url` is `/`
- `icons` point to existing files in `public/icons/`
- `display` is `standalone`

## Environment & Secrets

### Client Environment

Create `.env.production` (or configure in your hosting platform):

```env
VITE_SUPABASE_URL=https://<project-ref>.supabase.co
VITE_SUPABASE_ANON_KEY=<your-anon-key>
```

### Server Environment

Configure in Supabase Function settings:
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY` (never expose this publicly)
- `SUPABASE_ANON_KEY`

## Hosting Options

### Option 1: Vercel (Recommended for quick setup)

1. Push code to GitHub
2. Import project to [Vercel Dashboard](https://vercel.com/dashboard)
3. Configure build:
   - Build command: `npm run build`
   - Output directory: `dist`
4. Add environment variables in Vercel project settings
5. Deploy

Vercel config is already in `vercel.json`.

### Option 2: Netlify

1. Push code to GitHub
2. Connect to [Netlify](https://netlify.com)
3. Configure build:
   - Build command: `npm run build`
   - Publish directory: `dist`
4. Add environment variables in Netlify settings
5. Deploy

### Option 3: Self-hosted (Docker)

Create `Dockerfile`:

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build
RUN npm install -g serve
EXPOSE 3000
CMD ["serve", "-s", "dist", "-l", "3000"]
```

Build and run:
```bash
docker build -t vibe-beats .
docker run -p 3000:3000 vibe-beats
```

## Testing Deployment

### Smoke Tests

```bash
# Test app loads
curl https://<your-domain>

# Test manifest loads
curl https://<your-domain>/manifest.json

# Test service worker registration
# (Open browser DevTools → Application → Service Workers)

# Test API health endpoint
curl https://<your-supabase-project>.supabase.co/functions/v1/make-server-2e8e40fd/health
```

### Mobile Testing

- **iOS**: Open in Safari, use "Add to Home Screen"
- **Android**: Open in Chrome, use "Install app" prompt
- **Test offline**: Use DevTools Offline mode or disable network

### Browser DevTools Checks

1. **Service Worker**: Application → Service Workers (should show registered, running)
2. **Cache**: Application → Cache Storage (should contain app assets)
3. **Manifest**: Application → Manifest (should show loaded manifest.json)
4. **Network**: Should see API calls going to Supabase Edge Function

## Monitoring

### Client-side Monitoring

- Use browser error tracking (e.g., Sentry, Rollbar)
- Monitor service worker errors and offline incidents
- Track PWA installation events

### Backend Monitoring

- Monitor Edge Function logs in Supabase dashboard
- Set up alerts for function errors
- Monitor database (KV store) usage and latency

## Rollback

If issues arise:

1. **Revert code**: `git revert <commit>`
2. **Rebuild and redeploy**: `npm run build && <deploy command>`
3. **Clear browser cache**: Users may need to hard-refresh or clear app data
4. **Verify**: Test all endpoints and UI flows

## Post-Deployment

### Security

- Rotate Supabase keys periodically
- Monitor for unauthorized API calls
- Set up rate limiting if needed
- Enable CORS restrictions (currently set to "*" in Edge Function)

### Performance

- Monitor service worker cache hit rates
- Check API response times
- Optimize bundle size if needed (analyze with `npm run build && npm ls`)

### User Experience

- Collect feedback on PWA install experience
- Test on various devices and networks
- Monitor crash reports and errors

## Scaling Considerations

- **KV store performance**: For large user bases, consider migrating from KV table to proper Supabase PostgreSQL
- **Real-time updates**: Add Supabase Real-time subscriptions for live features (matches, messages)
- **Push notifications**: Implement FCM (Android) and APNs (iOS) with a push provider
- **File storage**: Use Supabase Storage for profile photos and songs artwork

## CI/CD Pipeline Example (GitHub Actions)

Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - run: npm ci
      - run: npm run build
      
      - name: Deploy to Vercel
        run: npx vercel deploy --prod --token ${{ secrets.VERCEL_TOKEN }}
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
```

## Troubleshooting Deployment

### Service Worker Not Updating
- Clear browser cache and service worker
- Verify precache manifest includes new assets
- Check service worker file is deployed and accessible

### API Errors on Deploy
- Verify environment variables are set
- Check Supabase function is deployed
- Review Edge Function logs for errors

### Slow Performance
- Check bundle size (`npm run build && npm ls`)
- Enable compression and caching on web server
- Use CDN for static assets

## References

- [Vite Deployment Guide](https://vitejs.dev/guide/static-deploy.html)
- [Supabase Edge Functions Deployment](https://supabase.com/docs/guides/functions/deploy)
- [PWA Deployment Best Practices](https://web.dev/progressive-web-apps/#deployment)
- [Vercel Deployment](https://vercel.com/docs/concepts/deployments/overview)
- [Netlify Deployment](https://docs.netlify.com/)
